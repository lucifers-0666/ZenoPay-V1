<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Government Banking System</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen overflow-x-hidden font-sans"
  >
  <%- include('partials/header') %>

    <!-- Main Content -->
    <div class="min-h-[80vh]">
      <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Back Button -->
        <a
          href="/"
          class="inline-flex items-center text-blue-700 hover:text-blue-900 font-semibold mb-6 transition-all hover:translate-x-[-4px]"
        >
          <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>

        <!-- Header Card -->
        <div
          class="bg-white rounded-2xl shadow-xl p-8 mb-8 border-t-4 border-blue-600"
        >
          <div class="text-center">
            <div
              class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mb-4 shadow-lg"
            >
              <i class="fas fa-university text-white text-3xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
              Open Bank Account
            </h1>
            <p class="text-gray-600 text-lg">
              KYC Verified Account Opening - Reserve Bank of India
            </p>
          </div>
        </div>

        <!-- Main Form -->
        <form
          id="accountForm"
          class="bg-white rounded-2xl shadow-xl p-8"
          onsubmit="return handleFormSubmit(event)"
          enctype="multipart/form-data"
        >
          <!-- Bank & Branch Details Section -->
          <div>
            <div class="flex items-center mb-6 pb-3 border-b-2 border-blue-100">
              <i
                class="fas fa-building-columns text-blue-600 text-2xl mr-3"
              ></i>
              <h3 class="text-2xl font-bold text-gray-800">
                Bank & Branch Details
              </h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Branch IFSC (Moved First) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-code-branch mr-2 text-blue-500"></i>IFSC Code
                  *
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="txtIFSC"
                    name="ifsc"
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all uppercase"
                    placeholder="SBIN0001234"
                    maxlength="11"
                    required
                  />
                  <button
                    type="button"
                    id="btnVerifyIFSC"
                    onclick="verifyIFSC()"
                    class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition-colors cursor-pointer whitespace-nowrap flex items-center gap-2"
                  >
                    Verify
                  </button>
                </div>
              </div>

              <!-- Bank Name (Replaced Dropdown with Readonly Input) -->
              <div class="md:col-span-1">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-bank mr-2 text-blue-500"></i>Bank Name
                </label>
                <input
                  type="text"
                  id="txtBankName"
                  name="bankName"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:outline-none cursor-not-allowed"
                  placeholder="Auto-filled via IFSC"
                />
              </div>

              <!-- Branch Name (ReadOnly) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>Branch
                  Name
                </label>
                <input
                  type="text"
                  id="txtBranchName"
                  name="branchName"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:outline-none cursor-not-allowed"
                  placeholder="Auto-filled via IFSC"
                />
              </div>

              <!-- Branch City (ReadOnly) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-city mr-2 text-blue-500"></i>Branch City
                </label>
                <input
                  type="text"
                  id="txtBranchCity"
                  name="branchCity"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:outline-none cursor-not-allowed"
                  placeholder="Auto-filled"
                />
              </div>

              <!-- Branch State (ReadOnly) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-map mr-2 text-blue-500"></i>Branch State
                </label>
                <input
                  type="text"
                  id="txtBranchState"
                  name="branchState"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:outline-none cursor-not-allowed"
                  placeholder="Auto-filled"
                />
              </div>

              <!-- Branch Email (ReadOnly) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-envelope-open mr-2 text-blue-500"></i>Branch
                  Email
                </label>
                <input
                  type="text"
                  id="txtBranchEmail"
                  name="branchEmail"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:outline-none cursor-not-allowed"
                  placeholder="Auto-filled"
                />
              </div>
            </div>
          </div>

          <!-- Account Configuration Section -->
          <div class="mt-8">
            <div
              class="flex items-center mb-6 pb-3 border-b-2 border-indigo-100"
            >
              <i class="fas fa-wallet text-indigo-600 text-2xl mr-3"></i>
              <h3 class="text-2xl font-bold text-gray-800">
                Account Configuration
              </h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Account Number (Manual Generate) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-hashtag mr-2 text-indigo-500"></i>Account
                  Number *
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="txtAccountNumber"
                    name="accountNumber"
                    readonly
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 font-mono focus:outline-none"
                    placeholder="Click Generate"
                  />
                  <button
                    type="button"
                    onclick="generateAccountNumber()"
                    class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md transition-colors cursor-pointer whitespace-nowrap"
                  >
                    Generate
                  </button>
                </div>
              </div>

              <!-- Account Type -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-list mr-2 text-indigo-500"></i>Account Type *
                </label>
                <select
                  id="ddlAccountType"
                  name="accountType"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-white"
                  required
                >
                  <option value="">Select Type</option>
                  <option value="Savings">Savings Account</option>
                  <option value="Current">Current Account</option>
                  <option value="Salary">Salary Account</option>
                </select>
              </div>

              <!-- Opening Balance -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-rupee-sign mr-2 text-indigo-500"></i>Opening
                  Balance *
                </label>
                <input
                  type="number"
                  id="txtOpeningBalance"
                  name="openingBalance"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                  placeholder="Min ₹1000"
                  required
                />
              </div>

              <!-- Transaction Limit -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-tachometer-alt mr-2 text-indigo-500"></i
                  >Daily Limit (₹) *
                </label>
                <input
                  type="number"
                  id="txtTxnLimit"
                  name="txnLimit"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                  placeholder="e.g. 50000"
                  required
                />
              </div>
            </div>
          </div>

          <!-- Personal Information Section -->
          <div class="mt-8">
            <div
              class="flex items-center mb-6 pb-3 border-b-2 border-purple-100"
            >
              <i class="fas fa-user-circle text-purple-600 text-2xl mr-3"></i>
              <h3 class="text-2xl font-bold text-gray-800">
                Personal Information
              </h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Aadhaar Number -->
              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-fingerprint mr-2 text-purple-500"></i>Aadhaar
                  Number *
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="txtAadharNumber"
                    name="aadharNumber"
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all font-mono tracking-wide"
                    placeholder="1234 5678 9012"
                    maxlength="14"
                    oninput="formatAadhaar(this)"
                    required
                  />
                  <button
                    type="button"
                    id="btnVerifyAadhaar"
                    onclick="verifyAadhaar()"
                    class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors cursor-pointer flex items-center gap-2"
                  >
                    Verify & Fetch
                  </button>
                </div>
              </div>

              <!-- Full Name (ReadOnly) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-user mr-2 text-purple-500"></i>Full Name
                </label>
                <input
                  type="text"
                  id="txtFullName"
                  name="fullName"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:outline-none cursor-not-allowed"
                  placeholder="As per Aadhaar"
                />
              </div>

              <!-- Date of Birth -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>Date
                  of Birth *
                </label>
                <input
                  type="date"
                  id="txtDOB"
                  name="dob"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                  required
                />
              </div>

              <!-- Gender -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-venus-mars mr-2 text-purple-500"></i>Gender *
                </label>
                <select
                  id="ddlGender"
                  name="gender"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all bg-white"
                  required
                >
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <!-- Profession -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-briefcase mr-2 text-purple-500"></i
                  >Profession *
                </label>
                <select
                  id="ddlProfession"
                  name="profession"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all bg-white"
                  required
                >
                  <option value="">Select Profession</option>
                  <option value="Salaried">Salaried</option>
                  <option value="Self-Employed">Self-Employed</option>
                  <option value="Business">Business Owner</option>
                  <option value="Student">Student</option>
                  <option value="Retired">Retired</option>
                </select>
              </div>

              <!-- Annual Income -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-money-bill-wave mr-2 text-purple-500"></i
                  >Annual Income *
                </label>
                <select
                  id="ddlIncome"
                  name="annualIncome"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all bg-white"
                  required
                >
                  <option value="">Select Income Range</option>
                  <option value="<5L">Less than ₹5 Lakhs</option>
                  <option value="5L-10L">₹5 Lakhs - ₹10 Lakhs</option>
                  <option value="10L-20L">₹10 Lakhs - ₹20 Lakhs</option>
                  <option value=">20L">Above ₹20 Lakhs</option>
                </select>
              </div>

              <!-- PAN Number -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-id-card mr-2 text-purple-500"></i>PAN Number
                  *
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="txtPanNumber"
                    name="panNumber"
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all uppercase"
                    placeholder="ABCDE1234F"
                    maxlength="10"
                    required
                  />
                  <button
                    type="button"
                    id="btnVerifyPan"
                    onclick="verifyPan()"
                    class="px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors cursor-pointer flex items-center gap-2"
                  >
                    Verify
                  </button>
                </div>
              </div>

              <!-- Email -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-envelope mr-2 text-purple-500"></i>Personal
                  Email *
                </label>
                <input
                  type="email"
                  id="txtEmail"
                  name="email"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                  placeholder="email@example.com"
                  required
                />
              </div>

              <!-- Mobile -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-phone mr-2 text-purple-500"></i>Mobile Number
                  *
                </label>
                <input
                  type="tel"
                  id="txtMobile"
                  name="mobile"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                  placeholder="10-digit mobile"
                  required
                />
              </div>

              <!-- City -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-city mr-2 text-purple-500"></i>City *
                </label>
                <input
                  type="text"
                  id="txtCity"
                  name="city"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                  required
                />
              </div>

              <!-- State -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-map mr-2 text-purple-500"></i>State *
                </label>
                <input
                  type="text"
                  id="txtState"
                  name="state"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                  required
                />
              </div>

              <!-- Pincode -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-map-pin mr-2 text-purple-500"></i>Pincode *
                </label>
                <input
                  type="number"
                  id="txtPincode"
                  name="pincode"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                  required
                />
              </div>

              <!-- Profile Image -->
              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-image mr-2 text-purple-500"></i>Profile Image
                  *
                </label>
                <div class="flex items-center space-x-4">
                  <div class="flex-shrink-0">
                    <img
                      id="imagePreview"
                      src="https://via.placeholder.com/100"
                      alt="Preview"
                      class="w-24 h-24 rounded-lg object-cover border-2 border-gray-300"
                    />
                  </div>
                  <label class="flex-1 cursor-pointer">
                    <span
                      class="block border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition-all"
                    >
                      <i
                        class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"
                      ></i>
                      <span class="block text-sm text-gray-600">
                        <span class="font-semibold text-purple-600"
                          >Click to upload</span
                        >
                        or drag and drop
                      </span>
                    </span>
                    <input
                      type="file"
                      id="fuProfileImage"
                      name="userImage"
                      class="hidden"
                      onchange="previewImage(event)"
                      accept="image/*"
                    />
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Debit Card Configuration -->
          <div class="mt-8 bg-gray-50 p-6 rounded-xl border border-gray-200">
            <div class="flex items-center mb-6 pb-3 border-b-2 border-gray-200">
              <i class="fas fa-credit-card text-gray-700 text-2xl mr-3"></i>
              <h3 class="text-2xl font-bold text-gray-800">
                Debit Card Issuance
              </h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Card Number (Auto) -->
              <div class="md:col-span-1">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-hashtag mr-2 text-gray-500"></i>Debit Card
                  Number
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="txtDebitCardNumber"
                    name="debitCardNumber"
                    readonly
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-200 font-mono tracking-wider"
                    placeholder="Generate Number"
                  />
                  <button
                    type="button"
                    onclick="generateDebitCard()"
                    class="px-4 py-3 bg-gray-700 hover:bg-gray-800 text-white font-medium rounded-lg shadow-md transition-colors cursor-pointer whitespace-nowrap"
                  >
                    Generate
                  </button>
                </div>
              </div>

              <!-- Name on Card (Auto-filled from Aadhaar) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-font mr-2 text-gray-500"></i>Name on Card *
                </label>
                <input
                  type="text"
                  id="txtCardName"
                  name="nameOnCard"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-gray-500 transition-all uppercase cursor-not-allowed"
                  placeholder="AUTO-FILLED FROM AADHAAR"
                  required
                />
              </div>

              <!-- Expiry & CVV (Auto) -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-calendar-alt mr-2 text-gray-500"></i>Expiry &
                  CVV
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="txtExpiry"
                    name="cardExpiry"
                    readonly
                    class="w-1/2 px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-200"
                    placeholder="MM/YY"
                  />
                  <input
                    type="text"
                    id="txtCVV"
                    name="cardCVV"
                    readonly
                    class="w-1/2 px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-200 text-center"
                    placeholder="XXX"
                  />
                </div>
              </div>

              <!-- PIN -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-key mr-2 text-gray-500"></i>Set PIN *
                </label>
                <input
                  type="password"
                  id="txtPin"
                  name="cardPin"
                  maxlength="4"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 transition-all text-center"
                  placeholder="****"
                  required
                />
              </div>
            </div>
          </div>

          <!-- Terms and Submit -->
          <div class="mt-8 border-t-2 border-gray-100 pt-6">
            <div class="flex items-start mb-6">
              <input
                type="checkbox"
                id="chkTerms"
                class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                required
              />
              <label class="text-sm text-gray-700">
                I agree to the
                <span
                  class="text-blue-600 font-semibold cursor-pointer hover:underline"
                  >terms and conditions</span
                >
                and confirm that all information provided is accurate.
                <span class="text-red-500">*</span>
              </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                type="submit"
                id="btnSubmit"
                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all flex items-center justify-center cursor-pointer"
              >
                Open Account
              </button>

              <button
                type="button"
                onclick="clearForm()"
                class="bg-gray-500 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl hover:bg-gray-600 transition-all flex items-center justify-center cursor-pointer text-center w-full"
              >
                Clear Form
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Logic Script -->
    <script>
   

      // --- IMAGE PREVIEW ---
      function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function () {
          const preview = document.getElementById("imagePreview");
          if (preview) preview.src = reader.result;
        };
        if (event.target.files.length > 0) {
          reader.readAsDataURL(event.target.files[0]);
        }
      }

      // --- AADHAAR FORMATTING ---
      function formatAadhaar(input) {
        let value = input.value.replace(/\D/g, "");
        let formattedValue = "";
        for (let i = 0; i < value.length; i++) {
          if (i > 0 && i % 4 === 0) {
            formattedValue += " ";
          }
          formattedValue += value[i];
        }
        input.value = formattedValue;
      }

      // --- BACKEND API CALLS & VERIFICATION ---

      // Lock helper: locks input and adds visual feedback
      function lockField(id) {
        const el = document.getElementById(id);
        if (el) {
          if (el.tagName === "SELECT") el.disabled = true;
          else el.readOnly = true;
          el.classList.add(
            "bg-gray-100",
            "cursor-not-allowed",
            "text-gray-600"
          );
        }
      }

      async function verifyIFSC() {
        const ifsc = document.getElementById("txtIFSC").value;
        const btn = document.getElementById("btnVerifyIFSC");

        if (ifsc.length < 5) {
          showToast("Please enter a valid IFSC Code", "error");
          return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        btn.disabled = true;

        try {
          const response = await fetch("/verify-ifsc", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ifsc }),
          });
          const data = await response.json();

          if (response.ok && data.success) {
            // Populate Fields
            document.getElementById("txtBankName").value = data.branch.BankName;
            document.getElementById("txtBranchName").value =
              data.branch.BranchName;
            document.getElementById("txtBranchCity").value = data.branch.City;
            document.getElementById("txtBranchState").value = data.branch.State;
            document.getElementById("txtBranchEmail").value =
              data.branch.BranchEmail;

            showToast("Branch Verified Successfully!", "success");

            // Lock fields
            lockField("txtIFSC");
            lockField("txtBankName");
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.replace("bg-blue-600", "bg-green-600");
          } else {
            showToast(data.message || "Branch not found", "error");
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        } catch (error) {
          console.error(error);
          showToast("Server error verifying IFSC", "error");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      function generateAccountNumber() {
        const randomAcc = Math.floor(
          100000000000 + Math.random() * 900000000000
        );
        document.getElementById("txtAccountNumber").value = randomAcc;
        showToast("Account Number Allocated", "success");
      }

      async function verifyAadhaar() {
        const aadhaar = document.getElementById("txtAadharNumber").value;
        const cleanAadhar = aadhaar.replace(/\s/g, "");
        const btn = document.getElementById("btnVerifyAadhaar");

        if (cleanAadhar.length !== 12) {
          showToast("Invalid Aadhaar Number", "error");
          return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        btn.disabled = true;

        try {
          const response = await fetch("/verify-aadhar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ aadharNumber: cleanAadhar }),
          });
          const data = await response.json();

          if (response.ok && data.success && data.details) {
            // Populate Fields
            const fullName = data.details.FullName || "";
            document.getElementById("txtFullName").value = fullName;

            // --- Set Name on Card ---
            document.getElementById("txtCardName").value =
              fullName.toUpperCase();
            lockField("txtCardName");

            if (data.details.DOB) {
              const d = new Date(data.details.DOB);
              document.getElementById("txtDOB").value = d
                .toISOString()
                .split("T")[0];
            }

            document.getElementById("ddlGender").value =
              data.details.Gender || "";
            document.getElementById("txtCity").value = data.details.City || "";
            document.getElementById("txtState").value =
              data.details.State || "";
            document.getElementById("txtPincode").value =
              data.details.Pincode || "";
            document.getElementById("txtEmail").value =
              data.details.Email || "";
            document.getElementById("txtMobile").value =
              data.details.Mobile || "";

            showToast("Identity Verified Successfully!", "success");

            // Lock Personal Info Fields
            [
              "txtAadharNumber",
              "txtFullName",
              "txtDOB",
              "ddlGender",
              "txtCity",
              "txtState",
              "txtPincode",
              "txtEmail",
              "txtMobile",
            ].forEach(lockField);

            btn.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
            btn.classList.replace("bg-purple-600", "bg-green-600");
          } else {
            showToast(data.message || "Aadhaar Not Found", "error");
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        } catch (error) {
          console.error(error);
          showToast("Server Error verifying Aadhaar", "error");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      async function verifyPan() {
        const pan = document.getElementById("txtPanNumber").value;
        const btn = document.getElementById("btnVerifyPan");

        if (pan.length < 10) {
          showToast("Invalid PAN format", "error");
          return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
          const response = await fetch("/verify-pan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ panNumber: pan }),
          });
          const data = await response.json();

          if (response.ok && data.success) {
            showToast("PAN Verified (Registered)", "success");
            lockField("txtPanNumber");
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.replace("bg-purple-600", "bg-green-600");
          } else {
            showToast("PAN Record Not Found in Database", "warning");
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        } catch (error) {
          console.error(error);
          showToast("Server error verifying PAN", "error");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      function generateDebitCard() {
        const randomCard = Math.floor(
          4000000000000000 + Math.random() * 9000000000000000
        );
        const today = new Date();
        const expMonth = String(today.getMonth() + 1).padStart(2, "0");
        const expYear = String(today.getFullYear() + 5).slice(-2);
        const cvv = Math.floor(100 + Math.random() * 900);

        // Format card number with spaces every 4 digits
        const formattedCard = String(randomCard)
          .match(/.{1,4}/g)
          .join(" ");

        document.getElementById("txtDebitCardNumber").value = formattedCard;
        document.getElementById("txtExpiry").value = `${expMonth}/${expYear}`;
        document.getElementById("txtCVV").value = cvv;

        showToast("Debit Card Generated", "success");
      }

      function clearForm() {
        document.getElementById("accountForm").reset();
        document.getElementById("imagePreview").src =
          "https://via.placeholder.com/100";
        showToast("Form cleared", "warning");
      }

      async function handleFormSubmit(e) {
        e.preventDefault();

        const form = document.getElementById("accountForm");
        const accNum = document.getElementById("txtAccountNumber").value;
        const branchName = document.getElementById("txtBranchName").value;

        if (!accNum || accNum === "Click Generate") {
          showToast("Please generate an Account Number first.", "error");
          return false;
        }
        if (!branchName) {
          showToast("Please verify IFSC Code first.", "error");
          return false;
        }

        const btn = document.getElementById("btnSubmit");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        const formData = new FormData(form);

        // Manually append disabled fields because FormData skips them.
        // Gender is disabled after verification.
        const ddlGender = document.getElementById("ddlGender");
        if (ddlGender && ddlGender.disabled) {
          formData.append("gender", ddlGender.value);
        }
        // Note: ReadOnly fields are automatically included by FormData, so no need to append them manually.

        try {
          const response = await fetch("/open-account", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();

          if (response.ok && data.success) {
            showToast("Account Opened Successfully!", "success");
            setTimeout(() => {
              window.location.href = "/"; // Redirect logic
            }, 2000);
          } else {
            showToast(data.message || "Failed to open account.", "error");
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        } catch (error) {
          console.error(error);
          showToast("Network Error occurred.", "error");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }

        return false;
      }
    </script>
  </body>
</html>
