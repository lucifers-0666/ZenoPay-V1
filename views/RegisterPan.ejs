
    <%- include('partials/header') %>
    <!-- Main Content Area -->
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Header Card -->
      <div
        class="bg-white rounded-2xl shadow-xl p-8 mb-8 border-t-4 border-green-600"
      >
        <div class="text-center">
          <div
            class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-full mb-4 shadow-lg"
          >
            <i class="fas fa-address-card text-white text-3xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            Register PAN Card
          </h1>
          <p class="text-gray-600">
            Income Tax Department - PAN Registration Portal
          </p>
        </div>
      </div>

      <!-- Form Card -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form
          id="panForm"
          enctype="multipart/form-data"
          onsubmit="event.preventDefault(); validateAndSubmit();"
        >
          <!-- Aadhaar Number -->
          <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">
              <i class="fas fa-id-card text-green-600 mr-2"></i>Aadhaar Number *
            </label>
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-grow">
                <input
                  type="text"
                  id="txtAadharNumber"
                  maxlength="14"
                  oninput="formatAadhar(this)"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none"
                  placeholder="xxxx xxxx xxxx"
                />
              </div>
              <div class="md:w-auto">
                <button
                  type="button"
                  id="btnVerifyAadhar"
                  onclick="verifyAadhar()"
                  class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all shadow-md cursor-pointer flex items-center justify-center gap-2"
                >
                  <i class="fas fa-check-circle"></i> Verify Aadhaar
                </button>
              </div>
            </div>
          </div>

          <!-- PAN -->
          <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">
              <i class="fas fa-address-card text-green-600 mr-2"></i>PAN Number
              *
            </label>
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-grow">
                <input
                  type="text"
                  id="txtPanNumber"
                  readonly
                  name="panNumber"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 font-mono font-bold tracking-wider text-gray-700 cursor-not-allowed"
                  placeholder="Click Generate"
                />
              </div>
              <div class="md:w-auto">
                <button
                  type="button"
                  onclick="generatePan()"
                  class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-all shadow-md cursor-pointer flex items-center justify-center gap-2"
                >
                  <i class="fas fa-magic"></i> Generate PAN
                </button>
              </div>
            </div>
          </div>

          <!-- Full Name -->
          <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">
              <i class="fas fa-user text-green-600 mr-2"></i>Full Name *
            </label>
            <input
              type="text"
              id="txtFullName"
              name="fullName"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
              placeholder="Enter full name"
            />
          </div>

          <!-- DOB & Gender -->
          <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-calendar text-green-600 mr-2"></i>Date of Birth
                *
              </label>
              <input
                type="date"
                id="txtDOB"
                name="dob"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
              />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-venus-mars text-green-600 mr-2"></i>Gender *
              </label>
              <select
                id="ddlGender"
                name="gender"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition bg-white"
              >
                <option value="0">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <!-- Mobile & Email -->
          <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-phone text-green-600 mr-2"></i>Mobile Number *
              </label>
              <input
                type="tel"
                id="txtMobile"
                name="mobile"
                maxlength="10"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
                placeholder="10-digit mobile number"
              />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-envelope text-green-600 mr-2"></i>Email *
              </label>
              <input
                type="email"
                id="txtEmail"
                name="email"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
                placeholder="email@example.com"
              />
            </div>
          </div>

          <!-- Father Name -->
          <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">
              <i class="fas fa-male text-green-600 mr-2"></i>Father's Name *
            </label>
            <input
              type="text"
              id="txtFatherName"
              name="fatherName"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
              placeholder="Enter father's name"
            />
          </div>

          <!-- Address -->
          <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">
              <i class="fas fa-home text-green-600 mr-2"></i>Residential Address
              *
            </label>
            <textarea
              id="txtAddress"
              name="address"
              rows="3"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
              placeholder="Enter full address"
            ></textarea>
          </div>

          <!-- City/State/Pincode -->
          <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-city text-green-600 mr-2"></i>City *
              </label>
              <input
                type="text"
                id="txtCity"
                name="city"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
                placeholder="City"
              />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-map text-green-600 mr-2"></i>State *
              </label>
              <input
                type="text"
                id="txtState"
                name="state"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
                placeholder="State"
              />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-2">
                <i class="fas fa-map-pin text-green-600 mr-2"></i>Pincode *
              </label>
              <input
                type="text"
                id="txtPincode"
                name="pincode"
                maxlength="6"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none transition"
                placeholder="6-digit"
              />
            </div>
          </div>

          <!-- Upload -->
          <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">
              <i class="fas fa-upload text-green-600 mr-2"></i>Upload Image *
            </label>
            <input
              type="file"
              id="fuImage"
              accept="image/*"
              name="userImage"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition"
            />
          </div>

          <!-- Buttons -->
          <div class="flex gap-4 mt-8">
            <button
              type="submit"
              id="btnSubmit"
              class="flex-1 bg-green-600 text-white py-4 rounded-lg font-semibold hover:bg-green-700 shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2"
            >
              <i class="fas fa-paper-plane"></i> Submit Registration
            </button>

            <a
              href="/"
              class="flex-1 bg-gray-500 text-white py-4 rounded-lg text-center font-semibold hover:bg-gray-600 shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2"
            >
              <i class="fas fa-arrow-left"></i> Back
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Logic Functions -->
    <script>
      // --- Formatting ---
      function formatAadhar(input) {
        let value = input.value.replace(/\s+/g, "").replace(/[^0-9]/g, "");
        if (value.length > 12) value = value.slice(0, 12);
        input.value = value.match(/.{1,4}/g)?.join(" ") || value;
      }

      function generatePan() {
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let pan = "";
        for (let i = 0; i < 5; i++)
          pan += letters.charAt(Math.floor(Math.random() * letters.length));
        pan += Math.floor(1000 + Math.random() * 9000); // 4 digits
        pan += letters.charAt(Math.floor(Math.random() * letters.length)); // 1 letter

        document.getElementById("txtPanNumber").value = pan;
        showToast("PAN Generated: " + pan, "success");
      }

      // --- API Calls ---

      async function verifyAadhar() {
        const aadharInput = document.getElementById("txtAadharNumber").value;
        const btn = document.getElementById("btnVerifyAadhar");

        const aadharClean = aadharInput.replace(/\s/g, "");

        if (aadharClean.length !== 12) {
          showToast("Invalid Aadhaar Number format", "error");
          return;
        }

        // UI Loading State
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        btn.disabled = true;

        try {
          const response = await fetch("/verify-aadhar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ aadharNumber: aadharClean }),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            showToast(data.message, "success");

            // Auto-fill fields if details exist
            if (data.details) {
              document.getElementById("txtFullName").value =
                data.details.FullName || "";
              // Format Date for Input Date field (YYYY-MM-DD)
              if (data.details.DOB) {
                const d = new Date(data.details.DOB);
                const formattedDate = d.toISOString().split("T")[0];
                document.getElementById("txtDOB").value = formattedDate;
              }

              document.getElementById("ddlGender").value =
                data.details.Gender || "0";
              document.getElementById("txtMobile").value =
                data.details.Mobile || "";
              document.getElementById("txtEmail").value =
                data.details.Email || "";
              document.getElementById("txtFatherName").value =
                data.details.FatherName || "";
              document.getElementById("txtAddress").value =
                data.details.Address || "";
              document.getElementById("txtCity").value =
                data.details.City || "";
              document.getElementById("txtState").value =
                data.details.State || "";
              document.getElementById("txtPincode").value =
                data.details.Pincode || "";

              // --- NEW: Lock the fields to prevent editing ---
              const fieldsToLock = [
                "txtAadharNumber",
                "txtFullName",
                "txtDOB",
                "ddlGender",
                "txtMobile",
                "txtEmail",
                "txtFatherName",
                "txtAddress",
                "txtCity",
                "txtState",
                "txtPincode",
              ];

              fieldsToLock.forEach((id) => {
                const element = document.getElementById(id);
                if (element) {
                  // Use disabled for selects, readOnly for inputs to show visual queue
                  if (element.tagName === "SELECT") {
                    element.disabled = true;
                  } else {
                    element.readOnly = true;
                  }
                  // Add Tailwind classes for visual "locked" state
                  element.classList.add(
                    "bg-gray-100",
                    "cursor-not-allowed",
                    "text-gray-600"
                  );
                }
              });

              // Also update verify button to show it's done
              btn.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
              btn.classList.remove("bg-blue-600", "hover:bg-blue-700");
              btn.classList.add("bg-green-600", "cursor-default");
              btn.disabled = true; // Keep button disabled
              return; // Exit to keep button disabled state
            }
          } else {
            showToast(data.message || "Aadhaar not found.", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Server error during verification", "error");
        } finally {
          // Only re-enable if NOT verified successfully (logic handled above)
          // We check the button text to decide if we should re-enable
          if (!btn.innerHTML.includes("Verified")) {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        }
      }

      async function validateAndSubmit() {
        // Collect Data
        const formData = {
          aadharNumber: document
            .getElementById("txtAadharNumber")
            .value.replace(/\s/g, ""),
          panNumber: document.getElementById("txtPanNumber").value,
          fullName: document.getElementById("txtFullName").value,
          dob: document.getElementById("txtDOB").value,
          gender: document.getElementById("ddlGender").value,
          mobile: document.getElementById("txtMobile").value,
          email: document.getElementById("txtEmail").value,
          fatherName: document.getElementById("txtFatherName").value,
          address: document.getElementById("txtAddress").value,
          city: document.getElementById("txtCity").value,
          state: document.getElementById("txtState").value,
          pincode: document.getElementById("txtPincode").value,
        };

        // File Upload Handling
        const fileInput = document.getElementById("fuImage");
        const file = fileInput.files[0];

        // Basic validation
        if (!formData.fullName || !formData.mobile || !formData.email) {
          showToast("Please fill in all required fields", "error");
          return;
        }
        if (!formData.panNumber) {
          showToast("Please generate PAN number first", "warning");
          return;
        }
        if (formData.gender === "0") {
          showToast("Please select a gender", "warning");
          return;
        }

        // Prepare data for transmission (FormData for multipart/form-data)
        const payload = new FormData();
        Object.keys(formData).forEach((key) =>
          payload.append(key, formData[key])
        );
        if (file) {
          payload.append("userImage", file);
        }

        const btn = document.getElementById("btnSubmit");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        btn.disabled = true;

        try {
          const response = await fetch("/register-pan", {
            method: "POST",
            body: payload, // Browser sets Content-Type boundary automatically
          });

          const data = await response.json();

          if (response.ok && data.success) {
            showToast(data.message, "success");

            // Optional: Redirect after delay
            setTimeout(() => {
              window.location.reload(); // or window.location.href = '/dashboard';
            }, 2000);
          } else {
            // Show the specific error message from the backend
            showToast(data.message || "Registration failed.", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("Network or Server Error", "error");
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
