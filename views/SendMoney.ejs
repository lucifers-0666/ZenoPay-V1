<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send Money - ZenoPay</title>
    <link rel="stylesheet" href="/css/dashboard.css" />
    <link rel="stylesheet" href="/css/header.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .send-money-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .page-header {
        margin-bottom: 2rem;
      }

      .page-title {
        font-size: 2rem;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }

      .page-subtitle {
        color: var(--text-light);
        font-size: 1rem;
      }

      .transfer-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }

      .transfer-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-size: 1.3rem;
        color: var(--primary-dark);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
      }

      .form-label i {
        color: var(--primary-blue);
        margin-right: 0.5rem;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 0.9rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(69, 104, 130, 0.1);
      }

      .form-input:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
      }

      .btn {
        padding: 0.9rem 2rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--primary-dark)
        );
        color: white;
        width: 100%;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(69, 104, 130, 0.3);
      }

      .btn-verify {
        background: var(--accent-beige);
        color: var(--primary-dark);
      }

      .btn-verify:hover {
        background: #d2c1b6;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .receiver-info {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
        display: none;
      }

      .receiver-info.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid #dee2e6;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: var(--text-light);
        font-size: 0.9rem;
      }

      .info-value {
        font-weight: 600;
        color: var(--text-dark);
      }

      .success-icon {
        color: var(--success);
        margin-right: 0.5rem;
      }

      .my-accounts-list {
        display: grid;
        gap: 1rem;
      }

      .account-item {
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--primary-dark)
        );
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
      }

      .account-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .account-item.selected {
        background: white;
        color: var(--primary-blue);
        border: 3px solid var(--primary-blue);
        box-shadow: 0 8px 25px rgba(69, 104, 130, 0.3);
      }

      .account-item.selected .account-bank,
      .account-item.selected .account-number,
      .account-item.selected .account-balance {
        color: var(--primary-blue);
      }

      .account-bank {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .account-number {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.3rem;
      }

      .account-balance {
        font-size: 1rem;
        font-weight: 700;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .no-accounts {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-light);
      }

      .no-accounts i {
        font-size: 3rem;
        color: var(--accent-beige);
        margin-bottom: 1rem;
      }

      .alert {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: none;
      }

      .alert.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* Custom Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.show {
        display: flex;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .modal-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--primary-dark)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 1rem;
      }

      .modal-title {
        font-size: 1.5rem;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
      }

      .modal-body {
        margin: 1.5rem 0;
      }

      .modal-detail {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid #eee;
      }

      .modal-detail:last-child {
        border-bottom: none;
      }

      .modal-label {
        color: var(--text-light);
        font-size: 0.95rem;
      }

      .modal-value {
        font-weight: 600;
        color: var(--text-dark);
      }

      .modal-amount {
        text-align: center;
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin: 1rem 0;
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .btn-cancel {
        background: #e0e0e0;
        color: var(--text-dark);
      }

      .btn-cancel:hover {
        background: #d0d0d0;
      }

      .daily-summary {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .summary-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .summary-date {
        font-size: 0.85rem;
        font-weight: 400;
        color: #666;
        margin-top: 0.25rem;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .stat-box {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
      }

      .stat-label {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-bottom: 0.3rem;
      }

      .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-blue);
      }

      @media (max-width: 968px) {
        .transfer-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <%- include('partials/header') %>

    <main class="main-content">
      <%- include('partials/navbar') %>

      <div class="send-money-container">
        <div class="page-header">
          <h1 class="page-title">
            <i class="fas fa-paper-plane"></i>
            Send Money
          </h1>
          <p class="page-subtitle">Transfer funds instantly to any account</p>
        </div>

        <!-- Daily Transaction Summary -->
        <div class="daily-summary">
          <div class="summary-title">
            <i class="fas fa-chart-line"></i>
            <div>
              <span>Today's Transaction Summary</span>
              <div class="summary-date" id="summaryDate"></div>
            </div>
          </div>
          <div class="summary-stats">
            <div class="stat-box">
              <div class="stat-label">Transactions Made</div>
              <div class="stat-value" id="dailyCount">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Total Amount Sent</div>
              <div class="stat-value" id="dailyAmount">₹ 0.00</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Daily Limit</div>
              <div class="stat-value">₹ 50,000</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Remaining Limit</div>
              <div class="stat-value" id="remainingLimit">₹ 50,000</div>
            </div>
          </div>
        </div>

        <div class="transfer-layout">
          <!-- Left: Select Account -->
          <div class="transfer-card">
            <h2 class="card-title">
              <i class="fas fa-wallet"></i>
              Select Your Account
            </h2>

            <% if (accounts && accounts.length > 0) { %>
            <div class="my-accounts-list" id="accountsList">
              <% accounts.forEach((account, index) => { %>
              <div
                class="account-item"
                data-account="<%= account.AccountNumber %>"
                data-bank="<%= account.BankName %>"
                data-balance="<%= account.OpeningBalance.toString() %>"
              >
                <div class="account-bank">
                  <i class="fas fa-university"></i>
                  <%= account.BankName %>
                </div>
                <div class="account-number">
                  Account: <%= account.AccountNumber %>
                </div>
                <div class="account-balance">
                  <i class="fas fa-coins"></i>
                  Balance: ₹ <%=
                  parseFloat(account.OpeningBalance.toString()).toLocaleString('en-IN',
                  {minimumFractionDigits: 2}) %>
                </div>
              </div>
              <% }); %>
            </div>
            <% } else { %>
            <div class="no-accounts">
              <i class="fas fa-inbox"></i>
              <p>You don't have any bank accounts yet.</p>
              <p style="margin-top: 0.5rem">
                <a
                  href="/open-account"
                  style="color: var(--primary-blue); text-decoration: underline"
                >
                  Open an account
                </a>
              </p>
            </div>
            <% } %>
          </div>

          <!-- Right: Transfer Form -->
          <div class="transfer-card">
            <h2 class="card-title">
              <i class="fas fa-exchange-alt"></i>
              Transfer Details
            </h2>

            <div id="alertBox" class="alert"></div>

            <form id="transferForm" onsubmit="handleTransfer(event)">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user"></i>
                  Receiver (ZenoPay ID / Email / Mobile)
                </label>
                <input
                  type="text"
                  id="receiverInfo"
                  class="form-input"
                  placeholder="Enter ZenoPay ID, Email, or Mobile number"
                  required
                />
              </div>

              <div class="form-group">
                <button
                  type="button"
                  class="btn btn-verify"
                  onclick="verifyReceiver()"
                >
                  <i class="fas fa-check-circle"></i>
                  Verify Receiver
                </button>
              </div>

              <div id="receiverInfoBox" class="receiver-info">
                <div class="info-row">
                  <span class="info-label">Name</span>
                  <span class="info-value" id="holderName">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">ZenoPay ID</span>
                  <span class="info-value" id="zenoPayId">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Email</span>
                  <span class="info-value" id="emailValue">-</span>
                </div>
              </div>

              <div
                class="form-group"
                id="accountSelectGroup"
                style="display: none"
              >
                <label class="form-label">
                  <i class="fas fa-university"></i>
                  Select Receiver's Account
                </label>
                <select
                  id="receiverAccountSelect"
                  class="form-select"
                  onchange="selectReceiverAccount()"
                >
                  <option value="">-- Select Account --</option>
                </select>
              </div>

              <div
                id="selectedAccountInfo"
                class="receiver-info"
                style="margin-top: 1rem"
              ></div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-money-bill-wave"></i>
                  Amount (₹)
                </label>
                <input
                  type="number"
                  id="amount"
                  class="form-input"
                  placeholder="Enter amount"
                  min="1"
                  step="0.01"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-comment-alt"></i>
                  Description (Optional)
                </label>
                <input
                  type="text"
                  id="description"
                  class="form-input"
                  placeholder="Add a note"
                />
              </div>

              <input type="hidden" id="senderAccount" name="senderAccount" />
              <input
                type="hidden"
                id="receiverAccount"
                name="receiverAccount"
              />

              <button
                type="submit"
                class="btn btn-primary"
                id="submitBtn"
                disabled
              >
                <i class="fas fa-paper-plane"></i>
                Send Money
              </button>
            </form>
          </div>
        </div>
      </div>
    </main>

    <script src="/js/Loader.js"></script>
    <script>
      let selectedAccount = null;
      let verifiedReceiver = null;
      let receiverAccounts = [];

      function selectAccount(accountNumber, bankName, balance) {
        selectedAccount = { accountNumber, bankName, balance };
        document.getElementById("senderAccount").value = accountNumber;

        document.querySelectorAll(".account-item").forEach((item) => {
          item.classList.remove("selected");
        });

        event.target.closest(".account-item").classList.add("selected");
        checkFormValidity();
      }

      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".account-item").forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();
            const accountNumber = this.dataset.account;
            const bankName = this.dataset.bank;
            const balance = parseFloat(this.dataset.balance);
            selectAccount(accountNumber, bankName, balance);
          });
        });
      });

      async function verifyReceiver() {
        const receiverInfo = document
          .getElementById("receiverInfo")
          .value.trim();

        if (!receiverInfo) {
          ZenoAlert.warning(
            "Input Required",
            "Please enter receiver's ZenoPay ID, Email, or Mobile number"
          );
          return;
        }

        ZenoPayLoader.show("Verifying receiver...");

        try {
          const response = await fetch("/verify-receiver", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ receiverInfo }),
          });

          const data = await response.json();
          ZenoPayLoader.hide();

          if (data.success) {
            verifiedReceiver = data.data;
            receiverAccounts = data.data.accounts;

            // Display user info
            document.getElementById("holderName").textContent =
              data.data.holderName;
            document.getElementById("zenoPayId").textContent =
              data.data.zenoPayId;
            document.getElementById("emailValue").textContent = data.data.email;
            document.getElementById("receiverInfoBox").classList.add("show");

            // Populate account dropdown
            const select = document.getElementById("receiverAccountSelect");
            select.innerHTML = '<option value="">-- Select Account --</option>';

            data.data.accounts.forEach((acc, index) => {
              const option = document.createElement("option");
              option.value = index;
              option.textContent = `${acc.bankName} - ${acc.accountType} (${acc.accountNumber})`;
              select.appendChild(option);
            });

            document.getElementById("accountSelectGroup").style.display =
              "block";
            ZenoAlert.success(
              "Receiver Verified!",
              "Please select receiver's account to proceed",
              { timer: 2000 }
            );
          } else {
            ZenoAlert.error("Verification Failed", data.message);
            verifiedReceiver = null;
            receiverAccounts = [];
            document.getElementById("receiverInfoBox").classList.remove("show");
            document.getElementById("accountSelectGroup").style.display =
              "none";
          }
        } catch (error) {
          ZenoPayLoader.hide();
          console.error("Error:", error);
          ZenoAlert.error(
            "Verification Error",
            "Unable to verify receiver. Please check your connection and try again."
          );
        }
      }

      function selectReceiverAccount() {
        const select = document.getElementById("receiverAccountSelect");
        const index = select.value;

        if (index !== "") {
          const account = receiverAccounts[index];
          document.getElementById("receiverAccount").value =
            account.accountNumber;

          // Show selected account details
          const infoBox = document.getElementById("selectedAccountInfo");
          infoBox.innerHTML = `
            <div class="info-row">
              <span class="info-label">Bank Name</span>
              <span class="info-value">${account.bankName}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Account Type</span>
              <span class="info-value">${account.accountType}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Account Number</span>
              <span class="info-value">${account.accountNumber}</span>
            </div>
          `;
          infoBox.classList.add("show");
          checkFormValidity();
        }
      }

      let pendingTransferData = null;

      async function handleTransfer(event) {
        event.preventDefault();

        if (!selectedAccount) {
          ZenoAlert.warning(
            "Account Required",
            "Please select an account to send money from"
          );
          return;
        }

        if (!verifiedReceiver) {
          ZenoAlert.warning(
            "Verification Required",
            "Please verify receiver details first"
          );
          return;
        }

        const amount = parseFloat(document.getElementById("amount").value);

        if (amount > selectedAccount.balance) {
          ZenoAlert.transaction.insufficientBalance();
          return;
        }

        pendingTransferData = {
          senderAccount: document.getElementById("senderAccount").value,
          receiverAccount: document.getElementById("receiverAccount").value,
          amount: amount,
          description:
            document.getElementById("description").value || "Fund Transfer",
        };

        // Show confirmation modal
        showConfirmationModal(pendingTransferData);
      }

      async function proceedWithTransfer() {
        if (!pendingTransferData) return;

        ZenoPayLoader.show("Processing transfer...");

        try {
          const response = await fetch("/send-to", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(pendingTransferData),
          });

          const data = await response.json();
          ZenoPayLoader.hide();

          if (data.success) {
            ZenoAlert.transaction.success(
              data.transactionID,
              pendingTransferData.amount
            );
            // Reload daily summary immediately
            loadDailySummary();
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            ZenoAlert.transaction.failed(data.message);
          }
        } catch (error) {
          ZenoPayLoader.hide();
          console.error("Error:", error);
          ZenoAlert.transaction.failed(
            "Network error. Please check your connection and try again."
          );
        }

        pendingTransferData = null;
      }

      function checkFormValidity() {
        const submitBtn = document.getElementById("submitBtn");
        const receiverAccountValue =
          document.getElementById("receiverAccount").value;
        submitBtn.disabled = !(
          selectedAccount &&
          verifiedReceiver &&
          receiverAccountValue
        );
      }

      function showAlert(message, type) {
        const alertBox = document.getElementById("alertBox");
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type} show`;

        setTimeout(() => {
          alertBox.classList.remove("show");
        }, 5000);
      }

      // Custom Modal Functions
      function showConfirmationModal(transferData) {
        document.getElementById("modalAmount").textContent = `₹ ${parseFloat(
          transferData.amount
        ).toLocaleString("en-IN", { minimumFractionDigits: 2 })}`;
        document.getElementById("modalFrom").textContent =
          transferData.senderAccount;
        document.getElementById("modalFromBank").textContent =
          selectedAccount.bankName;
        document.getElementById("modalTo").textContent =
          transferData.receiverAccount;
        document.getElementById("modalToBank").textContent =
          verifiedReceiver.holderName;
        document.getElementById("modalDescription").textContent =
          transferData.description || "Fund Transfer";

        document.getElementById("confirmModal").classList.add("show");
      }

      function closeModal() {
        document.getElementById("confirmModal").classList.remove("show");
      }

      function confirmTransfer() {
        closeModal();
        proceedWithTransfer();
      }

      // Load daily transaction summary
      function updateSummaryDate() {
        const dateElement = document.getElementById("summaryDate");
        if (dateElement) {
          const today = new Date();
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          dateElement.textContent = today.toLocaleDateString("en-IN", options);
        }
      }

      async function loadDailySummary() {
        updateSummaryDate();

        try {
          const response = await fetch("/daily-transaction-summary");
          const data = await response.json();

          if (data.success) {
            document.getElementById("dailyCount").textContent = data.count;
            document.getElementById(
              "dailyAmount"
            ).textContent = `₹ ${parseFloat(data.totalAmount).toLocaleString(
              "en-IN",
              { minimumFractionDigits: 2 }
            )}`;
            document.getElementById(
              "remainingLimit"
            ).textContent = `₹ ${parseFloat(data.remainingLimit).toLocaleString(
              "en-IN",
              { minimumFractionDigits: 2 }
            )}`;
          }
        } catch (error) {
          console.error("Error loading daily summary:", error);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadDailySummary();
      });
    </script>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-check"></i>
          </div>
          <h2 class="modal-title">Confirm Transfer</h2>
          <p style="color: var(--text-light); font-size: 0.95rem">
            Please review the transaction details
          </p>
        </div>

        <div class="modal-body">
          <div class="modal-amount" id="modalAmount">₹ 0.00</div>

          <div class="modal-detail">
            <span class="modal-label">From Account</span>
            <span class="modal-value" id="modalFrom">-</span>
          </div>
          <div class="modal-detail">
            <span class="modal-label">Bank</span>
            <span class="modal-value" id="modalFromBank">-</span>
          </div>
          <div class="modal-detail">
            <span class="modal-label">To Account</span>
            <span class="modal-value" id="modalTo">-</span>
          </div>
          <div class="modal-detail">
            <span class="modal-label">Receiver</span>
            <span class="modal-value" id="modalToBank">-</span>
          </div>
          <div class="modal-detail">
            <span class="modal-label">Description</span>
            <span class="modal-value" id="modalDescription">-</span>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            onclick="confirmTransfer()"
          >
            <i class="fas fa-check"></i> Confirm & Send
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
