<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fund Transfer - Govt Banking System</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

   
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loader" class="loader-overlay">
      <div class="flex flex-col items-center">
        <div class="spinner mb-4"></div>
        <p class="text-blue-600 font-bold text-lg animate-pulse">
          Processing Request...
        </p>
      </div>
    </div>

  <%-include ('partials/header') %>
    <div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-10">
          <div class="inline-block p-4 rounded-full bg-blue-100 mb-4 shadow-sm">
            <i class="fas fa-paper-plane text-4xl text-blue-600"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 tracking-tight">
            Fund Transfer
          </h1>
          <p class="mt-2 text-sm text-gray-600">
            Securely transfer money using Account No. or Phone No.
          </p>
          <div class="mt-4">
            <a href="/" class="text-blue-600 hover:underline"
              ><i class="fas fa-arrow-left"></i> Back to Dashboard</a
            >
          </div>
        </div>

        <!-- Main Content Card -->
        <div
          class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100"
        >
          <!-- Progress Header -->
          <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4">
            <div
              class="flex justify-between items-center text-white text-sm font-medium px-4"
            >
              <span class="flex items-center"
                ><i class="fas fa-user-circle mr-2"></i> Sender</span
              >
              <i class="fas fa-chevron-right opacity-50"></i>
              <span class="flex items-center"
                ><i class="fas fa-user-check mr-2"></i> Beneficiary</span
              >
              <i class="fas fa-chevron-right opacity-50"></i>
              <span class="flex items-center"
                ><i class="fas fa-rupee-sign mr-2"></i> Amount</span
              >
            </div>
          </div>

          <div class="p-8 space-y-8">
            <!-- Section 1: Sender Details -->
            <div class="bg-blue-50 rounded-xl p-6 border border-blue-100">
              <h3
                class="text-lg font-bold text-gray-800 mb-4 flex items-center"
              >
                <span
                  class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2"
                  >1</span
                >
                Debit From (Your Account)
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2 md:col-span-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Select Account</label
                  >
                  <div class="relative">
                    <select
                      id="ddlSenderAccount"
                      class="block w-full pl-10 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg shadow-sm appearance-none bg-white"
                    >
                      <option value="0">-- Select Account --</option>
                      <% if(accounts && accounts.length > 0) { %> <%
                      accounts.forEach(acc => { %>
                      <option
                        value="<%= acc.AccountNumber %>"
                        data-balance="<%= acc.OpeningBalance %>"
                      >
                        <%= acc.BankName %> - <%= acc.AccountNumber %>
                      </option>
                      <% }); %> <% } else { %>
                      <option disabled>No accounts found</option>
                      <% } %>
                    </select>
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <i class="fas fa-university text-gray-400"></i>
                    </div>
                    <div
                      class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
                    >
                      <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                  </div>
                </div>
                <div class="col-span-2 md:col-span-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Available Balance</label
                  >
                  <div class="relative rounded-md shadow-sm">
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <span class="text-gray-500 sm:text-sm">₹</span>
                    </div>
                    <input
                      type="text"
                      id="txtCurrentBalance"
                      readonly
                      class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-lg bg-gray-100 text-gray-600 font-mono font-bold cursor-not-allowed py-3"
                      value="0.00"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 2: Receiver Details -->
            <div class="bg-green-50 rounded-xl p-6 border border-green-100">
              <h3
                class="text-lg font-bold text-gray-800 mb-4 flex items-center"
              >
                <span
                  class="bg-green-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2"
                  >2</span
                >
                Credit To (Beneficiary)
              </h3>

              <!-- Transfer Mode Toggle -->
              <div class="flex gap-6 mb-6 border-b border-green-200 pb-4">
                <label class="flex items-center cursor-pointer">
                  <input
                    type="radio"
                    name="TransferMode"
                    id="rbAccount"
                    value="Account"
                    checked
                    class="form-radio text-green-600 h-4 w-4"
                  />
                  <span class="ml-2 text-sm font-medium text-gray-700"
                    >Bank Account</span
                  >
                </label>
                <label class="flex items-center cursor-pointer">
                  <input
                    type="radio"
                    name="TransferMode"
                    id="rbPhone"
                    value="Phone"
                    class="form-radio text-green-600 h-4 w-4"
                  />
                  <span class="ml-2 text-sm font-medium text-gray-700"
                    >Phone Number</span
                  >
                </label>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Input Field -->
                <div class="col-span-2 md:col-span-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span id="lblInputType">Account Number</span>
                  </label>
                  <div class="flex gap-2">
                    <div class="relative flex-1">
                      <div
                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                      >
                        <i class="fas fa-hashtag text-gray-400"></i>
                      </div>
                      <input
                        type="text"
                        id="txtReceiverInput"
                        class="focus:ring-green-500 focus:border-green-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3"
                        placeholder="Enter Number"
                      />
                    </div>
                    <button
                      id="btnVerify"
                      type="button"
                      class="hidden bg-green-600 hover:bg-green-700 text-white px-4 rounded-lg font-medium text-sm transition-colors shadow-sm cursor-pointer whitespace-nowrap"
                    >
                      Verify
                    </button>
                  </div>
                  <span
                    id="lblVerifyStatus"
                    class="text-xs mt-1 block h-4"
                  ></span>
                </div>

                <!-- Bank Name -->
                <div class="col-span-2 md:col-span-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Bank Name</label
                  >
                  <div class="relative">
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <i class="fas fa-landmark text-gray-400"></i>
                    </div>
                    <!-- Read-only input for verified bank, simpler for phone lookups -->
                    <input
                      type="text"
                      id="txtReceiverBank"
                      readonly
                      class="focus:ring-green-500 focus:border-green-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3 bg-gray-50 cursor-not-allowed"
                      placeholder="Auto-filled after verification"
                    />
                  </div>
                </div>

                <!-- Holder Name -->
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Beneficiary Name</label
                  >
                  <div class="relative">
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <input
                      type="text"
                      id="txtReceiverName"
                      readonly
                      class="focus:ring-green-500 focus:border-green-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3 bg-gray-50 cursor-not-allowed"
                      placeholder="Verified name will appear here"
                    />
                    <div
                      class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
                    >
                      <i
                        id="iconVerified"
                        class="fas fa-check-circle text-green-500 hidden"
                      ></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 3: Amount & Confirmation -->
            <div class="bg-purple-50 rounded-xl p-6 border border-purple-100">
              <h3
                class="text-lg font-bold text-gray-800 mb-4 flex items-center"
              >
                <span
                  class="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2"
                  >3</span
                >
                Transfer Details
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Amount (₹)</label
                  >
                  <div class="relative">
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <i class="fas fa-rupee-sign text-gray-400"></i>
                    </div>
                    <input
                      type="number"
                      id="txtAmount"
                      class="focus:ring-purple-500 focus:border-purple-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3 font-bold text-gray-800"
                      placeholder="0.00"
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Description / Remarks</label
                  >
                  <div class="relative">
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <i class="fas fa-comment-alt text-gray-400"></i>
                    </div>
                    <input
                      type="text"
                      id="txtDescription"
                      class="focus:ring-purple-500 focus:border-purple-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3"
                      placeholder="e.g. Rent, Family, Bill Payment"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Buttons -->
            <div
              class="flex items-center justify-end gap-4 pt-4 border-t border-gray-100"
            >
              <button
                id="btnReset"
                class="px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition duration-300 cursor-pointer"
              >
                Reset
              </button>
              <button
                id="btnTransfer"
                class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition duration-300 cursor-pointer"
              >
                Transfer Money
              </button>
            </div>
          </div>
        </div>

        <!-- Security Note -->
        <div class="mt-6 text-center text-xs text-gray-500 max-w-2xl mx-auto">
          <p>
            <i class="fas fa-shield-alt mr-1"></i> Payments are secured with
            256-bit encryption.
          </p>
        </div>
      </div>
    </div>

    <!-- Logic Script -->
    <script>
      // --- DOM ELEMENTS ---
      const ddlSenderAccount = document.getElementById("ddlSenderAccount");
      const txtCurrentBalance = document.getElementById("txtCurrentBalance");

      const rbAccount = document.getElementById("rbAccount");
      const rbPhone = document.getElementById("rbPhone");

      const lblInputType = document.getElementById("lblInputType");
      const txtReceiverInput = document.getElementById("txtReceiverInput");
      const btnVerify = document.getElementById("btnVerify");
      const lblVerifyStatus = document.getElementById("lblVerifyStatus");

      const txtReceiverBank = document.getElementById("txtReceiverBank");
      const txtReceiverName = document.getElementById("txtReceiverName");
      const iconVerified = document.getElementById("iconVerified");

      const txtAmount = document.getElementById("txtAmount");
      const txtDescription = document.getElementById("txtDescription");

      const btnReset = document.getElementById("btnReset");
      const btnTransfer = document.getElementById("btnTransfer");
      const loader = document.getElementById("loader");

      let targetAccNo = null; // Verified Receiver Account Number

      // --- 1. SENDER LOGIC ---
      ddlSenderAccount.addEventListener("change", function () {
        const selectedOpt = this.options[this.selectedIndex];
        if (this.value !== "0") {
          // Read the data-balance attribute set by EJS
          const balance = parseFloat(selectedOpt.getAttribute("data-balance"));
          txtCurrentBalance.value = balance.toFixed(2);
        } else {
          txtCurrentBalance.value = "0.00";
        }
      });

      // --- 2. RECEIVER MODE TOGGLE ---
      function toggleMode() {
        // Reset fields
        txtReceiverInput.value = "";
        txtReceiverName.value = "";
        txtReceiverBank.value = "";
        lblVerifyStatus.textContent = "";
        iconVerified.classList.add("hidden");
        targetAccNo = null;

        if (rbPhone.checked) {
          lblInputType.textContent = "Phone Number";
          txtReceiverInput.placeholder = "Enter 10-digit Phone Number";
          btnVerify.classList.remove("hidden");
          // Remove auto-postback on blur for phone, enforce click
          txtReceiverInput.removeEventListener("blur", handleAccountBlur);
        } else {
          lblInputType.textContent = "Account Number";
          txtReceiverInput.placeholder = "Enter Account Number";
          btnVerify.classList.add("hidden");
          // Add auto-postback on blur for account
          txtReceiverInput.addEventListener("blur", handleAccountBlur);
        }
      }

      rbAccount.addEventListener("change", toggleMode);
      rbPhone.addEventListener("change", toggleMode);

      // --- 3. VERIFICATION LOGIC ---

      // A. Account Mode: Auto-verify on blur
      function handleAccountBlur() {
        if (rbAccount.checked && this.value.trim() !== "") {
          verifyUser("Account", this.value.trim());
        }
      }

      // Initial attach
      txtReceiverInput.addEventListener("blur", handleAccountBlur);

      // B. Phone Mode: Button Click
      btnVerify.addEventListener("click", function () {
        const val = txtReceiverInput.value.trim();
        if (!val) return showToast("Please enter phone number", "warning");
        verifyUser("Phone", val);
      });

      async function verifyUser(mode, value) {
        showLoader(true);
        try {
          const response = await fetch("/transfer/verify-receiver", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mode, value }),
          });

          const res = await response.json();

          if (response.ok && res.success) {
            txtReceiverName.value = res.data.holderName;
            txtReceiverBank.value = res.data.bankName;
            targetAccNo = res.data.accountNumber; // Store for submission

            setVerifyStatus("Beneficiary Verified.", true);
          } else {
            resetReceiverFields(res.message || "User not found.");
          }
        } catch (error) {
          console.error(error);
          showToast("Verification failed due to network error", "error");
        } finally {
          showLoader(false);
        }
      }

      function setVerifyStatus(msg, isSuccess) {
        lblVerifyStatus.textContent = msg;
        lblVerifyStatus.className = isSuccess
          ? "text-xs mt-1 block h-4 text-green-500"
          : "text-xs mt-1 block h-4 text-red-500";
        if (isSuccess) iconVerified.classList.remove("hidden");
        else iconVerified.classList.add("hidden");
      }

      function resetReceiverFields(msg) {
        txtReceiverName.value = "";
        txtReceiverBank.value = "";
        targetAccNo = null;
        setVerifyStatus(msg, false);
      }

      // --- 4. TRANSFER LOGIC ---
      btnTransfer.addEventListener("click", async function () {
        // Validation
        if (ddlSenderAccount.value === "0")
          return showToast("Select a sender account.", "warning");
        if (!targetAccNo)
          return showToast("Verify beneficiary first.", "warning");

        const amount = parseFloat(txtAmount.value);
        if (isNaN(amount) || amount <= 0)
          return showToast("Enter valid amount.", "warning");

        // Client-side Balance Check
        const currentBal = parseFloat(txtCurrentBalance.value);
        if (currentBal < amount)
          return showToast("Insufficient Balance.", "error");

        if (ddlSenderAccount.value === targetAccNo)
          return showToast("Cannot transfer to self.", "error");

        // Execute Transaction
        showLoader(true);

        const payload = {
          senderAccount: ddlSenderAccount.value,
          receiverAccount: targetAccNo,
          amount: amount,
          description: txtDescription.value,
        };

        try {
          const response = await fetch("/transfer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const res = await response.json();

          if (response.ok && res.success) {
            showToast(
              `Transfer Successful! Ref: ${res.transactionID}`,
              "success"
            );

            // Update Balance UI immediately
            txtCurrentBalance.value = res.newBalance.toFixed(2);
            // Update the option attribute so refreshing dropdown works correctly
            const selectedOpt =
              ddlSenderAccount.options[ddlSenderAccount.selectedIndex];
            selectedOpt.setAttribute("data-balance", res.newBalance);

            clearFormPartial();
          } else {
            showToast(res.message || "Transfer Failed", "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Transaction failed due to network error", "error");
        } finally {
          showLoader(false);
        }
      });

      // --- 5. UTILITIES ---
      btnReset.addEventListener("click", clearFormFull);

      function clearFormPartial() {
        txtAmount.value = "";
        txtDescription.value = "";
      }

      function clearFormFull() {
        clearFormPartial();
        txtReceiverInput.value = "";
        toggleMode(); // Resets receiver part
        ddlSenderAccount.value = "0";
        txtCurrentBalance.value = "0.00";
      }

      function showLoader(show) {
        if (show) loader.classList.add("active");
        else loader.classList.remove("active");
      }

   </script>
  </body>
</html>
